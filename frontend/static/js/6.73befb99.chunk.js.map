{"version":3,"sources":["components/video/VideoPage.js"],"names":["VideoPage","state","UserVideos","AllVideos","offset","searchInputValue","isFetching","popupOpen","Done","pageId","props","match","params","id","isPageMine","getCookie","fetchLimit","addVideoRef","createRef","fetchVideo","a","val","address","HTTP","ADDR","userId","withValue","limit","setState","Fetcher","error","response","console","log","fetchInitialVideos","handleScrollThrottled","Throttle","Math","abs","window","scrollY","innerHeight","document","documentElement","scrollHeight","fetchInitialVideosDebounced","Debounce","onPopupClose","onFileDownloaded","current","files","length","postVideo","title","data","FormData","append","video_id","adder_id","myId","name","addToPlaylistHandler","videoId","deleteVideo","filter","video","onInputChange","event","target","value","this","addEventListener","removeEventListener","className","style","color","placeholder","onChange","type","accept","ref","htmlFor","map","about","Video","key","deleteMusicHandler","Boolean","AddVideoPopup","onClose","_onSend","React","Component","useState","buttonActive","updateButtonActive","hover","updateHover","onFocus","onBlur","tabIndex","onMouseEnter","onMouseLeave","src","PathFromIdGenerator","preload","controls","onClick","e","stopPropagation","disabled","to","_updateTitle","withRouter"],"mappings":"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","file":"static/js/6.73befb99.chunk.js","sourcesContent":["import React, {createRef, useState} from \"react\";\nimport \"./video_page.scss\"\nimport \"../../scss/page.scss\";\nimport \"../../scss/video_audio.scss\";\nimport {withRouter, NavLink as Link} from \"react-router-dom\"\nimport Fetcher from \"../../functools/Fetcher\";\nimport Debounce from \"../../functools/Debounce\";\nimport Throttle from \"../../functools/Trottle\";\nimport getCookie from \"../../functools/getCookie\";\nimport PathFromIdGenerator from \"../../functools/PathFromIdGenerator\";\nimport {HTTP, ADDR} from \"../../address\";\n\nclass VideoPage extends React.Component{\n    state = { UserVideos: [], AllVideos : [], offset: 0, searchInputValue: \"\", isFetching: false, popupOpen: false, Done: false}\n    pageId = + this.props.match.params.id;\n    isPageMine = +getCookie(\"userId\") === this.pageId;\n    fetchLimit = 16;\n    addVideoRef = createRef()\n\n    fetchVideo = async () => {\n        const offset = this.state.offset;\n        const val = this.state.searchInputValue;\n        const address = HTTP + ADDR + `/video/${val === \"\"? \"get_user_video\" : \"get_combined_video\" }`;\n        const params = {userId: this.pageId, offset: offset, withValue: val, limit: this.fetchLimit}\n        this.setState({isFetching: true});\n        const [error, response] = await Fetcher(\n            address,\n            params\n        )\n        if (error === null){\n            this.setState(state => ({\n                offset: offset + this.fetchLimit,\n                UserVideos: [...state.UserVideos, ...response.UserVideos],\n                AllVideos: [...state.AllVideos, ...response.AllVideos],\n                Done: response.Done\n            }));\n        }else {\n            console.log(error);\n        }\n        this.setState({isFetching: false});\n    }\n\n    fetchInitialVideos = ()=>{\n        this.setState(\n            {offset: 0, Done: false, UserVideos: [], AllVideos : []},\n            () => this.fetchVideo()\n        );\n    }\n\n    componentDidMount(){\n        this.fetchInitialVideos();\n        window.addEventListener('scroll', this.handleScrollThrottled, true);\n    }\n\n    componentWillUnmount() {\n        window.removeEventListener('scroll', this.handleScrollThrottled);\n    }\n\n    handleScrollThrottled = Throttle(() => {\n        if ((Math.abs(window.scrollY + window.innerHeight - document.documentElement.scrollHeight) < 10)\n            &&\n            !this.state.Done\n            &&\n            !this.state.popupOpen\n            &&\n            !this.state.isFetching\n        ){\n            this.fetchVideo();\n        }\n    }, 1000);\n\n    \n    fetchInitialVideosDebounced = Debounce(()=>{\n        this.setState(\n            {UserVideos: [], AllVideos : [], offset: 0},\n            () => this.fetchInitialVideos()\n        );\n    }, 500);\n\n    \n    onPopupClose = ()=>{\n        this.setState({popupOpen: false});\n    }\n\n    onFileDownloaded = ()=>{\n        if (this.addVideoRef.current.files.length) {\n            this.setState({popupOpen: true});\n        }\n    }\n\n    postVideo = async (title)=>{\n        this.onPopupClose();\n        const data = new FormData();\n        data.append(\"video\", this.addVideoRef.current.files[0])\n        const [error, response] = await Fetcher(\n            HTTP + ADDR + '/video/post_video',\n            {title},\n            'POST',\n            \"text\",\n            data);\n\n        if (error === null){\n            this.setState(state => (\n                {UserVideos:\n                    [\n                        {\n                            video_id: +response,\n                            adder_id: this.myId,\n                            name: title\n                        },\n                        ...state.UserVideos\n                    ],\n                    offset: state.offset + 1\n            }))\n        }\n    }\n\n    addToPlaylistHandler = (videoId) => {\n        Fetcher(\n            HTTP + ADDR + \"/video/add_to_playlist\",\n            {videoId},\n            \"POST\",\n            \"text\"\n        )\n    }\n\n    deleteVideo = async(videoId) =>{\n        const [error] = await Fetcher(\n            HTTP + ADDR + \"/video/remove_video\",\n            {videoId},\n            \"GET\",\n            \"text\"\n        )\n        if (error === null){\n            this.setState(state => ({\n                    offset: this.offset - 1,\n                    UserVideos: state.UserVideos.filter((video)=>video.video_id !== videoId)}\n            ));\n        }else {\n            console.log(error);\n        }\n    }\n\n\n    onInputChange = (event)=> {\n        this.setState({searchInputValue: event.target.value});\n        this.fetchInitialVideosDebounced()\n    }\n\n    render() {\n        return (\n            <div className={\"page__container\"}>\n                <div className={\"page__header background_pic__city background_pic__city_blue\"}>\n                    <h1 style={{color: \"white\"}}>Видео</h1>\n                    <p style={{color:  \"white\"}}>Здесь вы можете посмотреть видео</p>\n                    <div className={\"video_foreground_pic default_img\"}/>\n                </div>\n                <div className={\"VA_func_block\"}>\n                    <input className={\"default_search_input\"}\n                           placeholder={\"Поиск видео\"}\n                           onChange={this.onInputChange}\n\n                    />\n                    <input\n                        type={\"file\"}\n                        className={\"hidden_input\"}\n                        id = {\"select_video_file__input\"}\n                        accept={\"video/*\"}\n                        onChange={this.onFileDownloaded}\n                        ref = {this.addVideoRef}\n                    />\n                    <label htmlFor=\"select_video_file__input\">+</label>\n                </div>\n                <div className={\"videos__container\"}>\n                    {\n                        this.state.UserVideos.map((about )=> (\n                            <Video key = {about.video_id}\n                                   about = {about}\n                                   isPageMine = {this.isPageMine}\n                                   videoId = {about.video_id}\n                                   deleteMusicHandler = {this.deleteVideo}\n                            />\n                        ))\n                    }\n                </div>\n                {Boolean(this.state.AllVideos.length) && <span>Все видео</span>}\n                <div className={\"videos__container\"}>\n                    {\n                        this.state.AllVideos.map((about )=> (\n                            <Video key = {about.video_id}\n                                   about = {about}\n                                   videoId = {about.video_id}\n                                   addToPlaylistHandler = {this.addToPlaylistHandler}\n                            />\n                        ))\n                    }\n                </div>\n                {this.state.isFetching && <span>Загрузка...</span>}\n                {this.state.popupOpen && <AddVideoPopup onClose={this.onPopupClose} _onSend={this.postVideo}/>}\n            </div>\n        )\n    }\n}\n\nfunction Video({about, isPageMine, videoId, addToPlaylistHandler, deleteMusicHandler}) {\n    const [buttonActive, updateButtonActive] = useState(true);\n    const [hover, updateHover] = useState(false);\n\n    const onFocus = ()=>{\n        updateHover(true);\n    }\n\n    const onAdd = (e)=>{\n        e.stopPropagation();\n        addToPlaylistHandler(videoId);\n        updateButtonActive(false);\n    }\n\n    const onDelete = (e) =>{\n        e.stopPropagation();\n        deleteMusicHandler(videoId);\n    }\n\n    const onBlur = ()=>{\n        updateHover(false);\n    }\n\n    return (\n        <div className={\"video__container\"}>\n            <div className={\"video__header\"}>\n                <span className={\"video_name\"}>{about.name}</span>\n            </div>\n            <video\n                tabIndex={0}\n                onFocus={onFocus}\n                onBlur={onBlur}\n                onMouseEnter={onFocus}\n                onMouseLeave={onBlur}\n                className={\"video\"}\n                src={HTTP + ADDR + `/video_storage${PathFromIdGenerator(about.video_id)}/video.mp4`}\n                preload={\"metadata\"}\n                controls = {hover}\n            />\n            <span className={\"video_functional\"}>\n                {\n                    isPageMine ?\n                        <button onClick={onDelete}>-</button>\n                        :\n                        <button\n                            disabled={!buttonActive}\n                            onClick={onAdd}\n                        >{buttonActive ? '+' : '✓'}\n                        </button>\n                }\n                <Link to = {`/профиль/${about.adder_id}`}>Страница автора ⇢</Link>\n            </span>\n        </div>\n    )\n}\n\nfunction AddVideoPopup({onClose, _onSend}) {\n    const [title, _updateTitle] = useState(\"\");\n\n    const onSend = () =>{\n        _onSend(title);\n    }\n\n    const updateTitle = ({target})=>{\n        _updateTitle(target.value);\n    }\n    return (\n        <div className=\"b-popup\">\n            <div className=\"b-popup-content\">\n                <button className={\"popup_button__close\"} onClick={onClose}>×</button>\n                <input placeholder={\"Название\"} value={title} onChange={updateTitle}/>\n                <button className={\"popup_button__action\"} onClick={onSend}>Загрузить</button>\n            </div>\n        </div>\n    )\n}\n\nexport default withRouter(VideoPage);"],"sourceRoot":""}