{"version":3,"sources":["components/gallery/GalleryPage.js"],"names":["GalleryPage","addImageRef","createRef","fetchLimit","pageId","props","match","params","id","state","ImagesList","offset","isFetching","Done","error","handleError","bind","handleClose","fetchImages","a","setState","Fetcher","HTTP","ADDR","limit","startFrom","userId","response","handleScrollThrottled","Throttle","Math","round","window","scrollY","innerHeight","document","documentElement","scrollHeight","postImageHandler","current","files","length","data","FormData","append","imageId","image_id","adder_id","myId","deleteImageHandler","address","filter","image","this","addEventListener","removeEventListener","className","style","color","type","accept","ref","onChange","htmlFor","map","idx","PhotoBlock","key","text","React","Component","memo","console","log","PathFromIdGenerator","useState","isExpanded","update","src","onClick","alt","withRouter"],"mappings":"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","file":"static/js/7.a3196bbe.chunk.js","sourcesContent":["import React, {createRef, memo, useState} from \"react\";\nimport \"./gallery_page.scss\"\nimport Fetcher from \"../../functools/Fetcher\";\nimport Throttle from \"../../functools/Trottle\";\nimport \"../../scss/default_blocks.scss\";\nimport PathFromIdGenerator from \"../../functools/PathFromIdGenerator\";\nimport {withRouter} from \"react-router-dom\"\nimport {HTTP, ADDR} from \"../../address\";\nimport \"../../scss/hidden_input.scss\"\nimport \"../../scss/hidden_input.scss\"\nimport InfoPopup, {handleError, handleClose} from \"../infoPopup/infoPopup\";\n\nclass GalleryPage extends React.Component{\n    addImageRef = createRef();\n    fetchLimit = 17;\n    pageId = + this.props.match.params.id;\n    state = {ImagesList: [], offset: 0, isFetching: false, Done: false, error: null}\n    handleError = handleError.bind(this);\n    handleClose = handleClose.bind(this);\n    componentDidMount() {\n        this.fetchImages(this.fetchLimit - 1);\n        window.addEventListener('scroll', this.handleScrollThrottled, true);\n    }\n\n    componentWillUnmount() {\n        window.removeEventListener('scroll', this.handleScrollThrottled);\n    }\n\n    fetchImages = async (fetchLimit) => {\n        this.setState(() => ({isFetching: true}));\n        const [error, response] = await Fetcher(\n            HTTP + ADDR + \"/gallery/get_images\",\n            {limit: fetchLimit, startFrom: this.state.offset, userId : this.pageId}\n        )\n\n        if (error === null){\n            this.setState(state => ({\n                offset: state.offset + fetchLimit,\n                ImagesList: [...state.ImagesList, ...response.ImagesList],\n                Done: response.Done\n            }));\n        }else {\n            this.handleError(\"Невозможно получить данные с сервера\")\n        }\n        this.setState(() => ({isFetching: false}));\n    };\n    \n\n    handleScrollThrottled = Throttle(()=>{\n        if (Math.round(window.scrollY + window.innerHeight) === document.documentElement.scrollHeight\n            &&\n            !this.state.Done\n            &&\n            !this.state.isFetching\n        ){\n            this.fetchImages(this.fetchLimit);\n        }\n    }, 1000)\n\n    postImageHandler = async ()=>{\n        if (this.addImageRef.current.files.length){\n            const data = new FormData();\n            data.append(\"image\", this.addImageRef.current.files[0])\n\n            const [error, response] = await Fetcher(\n                HTTP + ADDR + '/gallery/post_image',\n                {},\n                \"post\",\n                \"text\",\n                data\n                );\n\n            if (error === null){\n                const imageId = +response;\n                this.setState(state => ({ImagesList:\n                        [\n                            {image_id:\n                                imageId,\n                                adder_id: this.myId,\n                            },\n                            ...state.ImagesList\n                        ],\n                    offset: state.offset + 1\n                }))\n            }else{\n                this.handleError(\"Невозможно добавить изображение\")\n            }\n\n        }\n    }\n\n    deleteImageHandler = async (imageId)=>{\n        //todo delete\n        const address = HTTP + ADDR + \"/gallery/delete_image\"\n        const params = {imageId: imageId}\n\n        const [error] = await Fetcher(\n            address,\n            params,\n            \"GET\",\n            \"text\"\n        )\n\n        if (error === null){\n            this.setState(state => (\n                        {\n                            offset: state.offset - 1,\n                            ImagesList: state.ImagesList.filter((image)=>image.image_id !== imageId)\n                        }\n                    )\n            );\n        }else {\n            this.handleError(\"Невозможно удалить изображение\")\n        }\n    }\n\n    render() {\n        return (\n            <div className={\"page__container\"}>\n                <div className={\"page__header background_pic__city background_pic__city_purple\"}>\n                    <h1 style={{color: \"white\"}}>Фотографии</h1>\n                    <p style={{color:  \"white\"}}>Здесь вы можете посмотреть фотографии</p>\n                    <div className={\"default_img\"}/>\n                </div>\n\n                <div className={\"gallery__container\"}>\n                    <div className={\"gallery__item\"}>\n                        <input\n                            type={\"file\"}\n                            className={\"hidden_input\"}\n                            id = {\"select_image_file__input\"}\n                            accept={\"image/jpeg\"}\n                            ref = {this.addImageRef}\n                            onChange={this.postImageHandler}\n                        />\n                        <label className={\"gallery__button_add\"}\n                               htmlFor=\"select_image_file__input\">\n                            +\n                        </label>\n                    </div>\n                    {\n                        this.state.ImagesList.map((image, idx) =>\n                            <PhotoBlock\n                                key = {idx}\n                                imageId={image.image_id}\n                                deleteImageHandler = {this.deleteImageHandler}\n                            />\n                        )\n                    }\n                </div>\n                {this.state.isFetching && <span>Загрузка...</span>}\n                {this.state.error && <InfoPopup text = {this.state.error} handleClose = {this.handleClose}/>}\n            </div>\n        )\n    }\n}\nconst PhotoBlock = memo(({imageId, deleteImageHandler}) =>{\n    console.log(\"render\", imageId);\n    const address = HTTP + ADDR + \"/gallery_storage\" + PathFromIdGenerator(imageId) + \"/img.jpg\";\n    const [isExpanded, update] = useState(false);\n    const updateSize = ()=>{\n        update(!isExpanded);\n    }\n\n    const onDeleteImage = () =>{\n        update(false);\n        deleteImageHandler(imageId);\n    }\n\n    return (\n        <div className={\"gallery__item\"}>\n            <img className={`gallery__photo ${isExpanded ? 'photo__expanded': null}`}\n                 src={address}\n                 onClick={updateSize}\n                 alt = {\" \"}\n            />\n            {isExpanded\n            &&\n            <button className={\"gallery_delete_photo_button\"}\n                    onClick={onDeleteImage}\n            >\n                Удалить\n            </button>}\n        </div>\n    )\n})\n\nexport default withRouter(GalleryPage)"],"sourceRoot":""}