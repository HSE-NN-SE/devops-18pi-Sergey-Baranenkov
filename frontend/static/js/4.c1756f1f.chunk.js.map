{"version":3,"sources":["components/audio/AudioPage.js","images/track_cover.ico"],"names":["AudioPage","state","UserMusic","AllMusic","offset","searchInputValue","isFetching","popupOpen","Done","error","pageId","props","match","params","id","isPageMine","playerStoreState","userId","fetchLimit","addMusicRef","createRef","myId","getCookie","handleError","bind","handleClose","fetchMusic","a","val","address","HTTP","ADDR","withValue","limit","setState","Fetcher","response","fetchInitialMusic","handleScrollThrottled","Throttle","console","log","Math","abs","window","scrollY","innerHeight","document","documentElement","scrollHeight","fetchInitialMusicDebounced","Debounce","onPopupClose","onFileDownloaded","current","files","length","postMusic","author","title","data","FormData","append","music_id","adder_id","name","addToPlaylistHandler","musicId","deleteMusic","filter","track","playUserMusicHandler","updatePlayerStoreState","playlist","trackIndex","done","playlistName","playAllMusicHandler","onInputChange","event","target","value","this","addEventListener","removeEventListener","prevProps","prevState","snapshot","className","text","style","color","placeholder","onChange","type","accept","ref","htmlFor","map","UserTrack","key","playMusicHandler","deleteMusicHandler","AddAudioPopup","onClose","_onSend","React","Component","memo","useState","buttonActive","updateButtonActive","onClick","src","track_cover","alt","e","stopPropagation","disabled","_updateAuthor","_updateTitle","withRouter","module","exports"],"mappings":"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","file":"static/js/4.c1756f1f.chunk.js","sourcesContent":["import React, {createRef, useState, memo} from \"react\";\nimport \"./audio.scss\"\nimport \"../../scss/video_audio.scss\";\nimport \"../../scss/default_popup.scss\"\nimport Debounce from \"../../functools/Debounce\";\nimport Throttle from \"../../functools/Trottle\";\nimport Fetcher from \"../../functools/Fetcher\";\nimport \"../../scss/hidden_input.scss\"\nimport {withRouter} from \"react-router-dom\"\nimport track_cover from \"../../images/track_cover.ico\"\nimport {HTTP,  ADDR} from \"../../address\";\nimport InfoPopup, {handleError, handleClose} from \"../infoPopup/infoPopup\";\nimport getCookie from \"../../functools/getCookie\";\n\nclass AudioPage extends React.Component{\n    state = {\n        UserMusic: [],\n        AllMusic : [],\n        offset: 0,\n        searchInputValue: \"\",\n        isFetching: false,\n        popupOpen: false,\n        Done: false,\n        error: null\n    }\n    pageId = + this.props.match.params.id;\n    isPageMine = this.props.playerStoreState.userId === this.pageId;\n    fetchLimit = 20;\n    addMusicRef = createRef();\n    myId = + getCookie(\"userId\");\n    handleError = handleError.bind(this);\n    handleClose = handleClose.bind(this);\n    fetchMusic = async () => {\n        const offset = this.state.offset;\n        const val = this.state.searchInputValue;\n        const address = HTTP + ADDR + `/music/${val === \"\"? \"get_user_music\" : \"get_combined_music\" }`;\n        const params = {userId: this.pageId, offset: offset, withValue: val, limit: this.fetchLimit}\n        this.setState({isFetching: true});\n        const [error, response] = await Fetcher(\n            address,\n            params\n        )\n        if (error === null){\n            this.setState(state => ({\n                offset: offset + this.fetchLimit,\n                UserMusic: [...state.UserMusic, ...response.UserMusic],\n                AllMusic: [...state.AllMusic, ...response.AllMusic],\n                Done: response.Done\n            }));\n        }else {\n            this.handleError(\"ошибка при получении данных с сервера\");\n        }\n        this.setState({isFetching: false});\n    }\n\n    fetchInitialMusic = ()=> {\n        this.setState(\n            {offset: 0, Done: false, UserMusic: [], AllMusic : []},\n            () => this.fetchMusic()\n        );\n    }\n\n    componentDidMount(){\n        this.fetchInitialMusic();\n        window.addEventListener('scroll', this.handleScrollThrottled, true);\n    }\n\n    componentWillUnmount() {\n        window.removeEventListener('scroll', this.handleScrollThrottled);\n    }\n\n    componentDidUpdate(prevProps, prevState, snapshot) {\n        if (prevProps !== this.props){\n            this.pageId = + this.props.match.params.id;\n            this.setState({UserMusic: [],\n                AllMusic : [],\n                offset: 0,\n                searchInputValue: \"\",\n                isFetching: false,\n                popupOpen: false,\n                Done: false,\n                error: null}, ()=> this.fetchInitialMusic());\n        }\n    }\n\n    handleScrollThrottled = Throttle(()=>{\n        console.log(this.state.Done, this.state.popupOpen, this.state.isFetching);\n        if ((Math.abs(window.scrollY + window.innerHeight - document.documentElement.scrollHeight) < 10)\n            &&\n            !this.state.Done\n            &&\n            !this.state.popupOpen\n            &&\n            !this.state.isFetching\n        ){\n            this.fetchMusic();\n        }\n    }, 1000 )\n\n\n    fetchInitialMusicDebounced = Debounce(()=>{\n        this.setState(\n            {UserMusic: [], AllMusic : [], offset: 0},\n            () =>this.fetchInitialMusic()\n        );\n    }, 500);\n\n\n    onPopupClose = ()=>{\n        this.setState({popupOpen: false});\n    }\n\n    onFileDownloaded = ()=>{\n        if (this.addMusicRef.current.files.length) {\n            this.setState({popupOpen: true});\n        }\n    }\n\n    postMusic = async (author, title)=>{\n        this.onPopupClose();\n        const data = new FormData();\n        data.append(\"audio\", this.addMusicRef.current.files[0])\n        const [error, response] = await Fetcher(\n            HTTP + ADDR + \"/music/post_music\",\n            {author, title},\n            'POST',\n            \"text\",\n            data);\n\n        if (error === null){\n            this.setState(state => (\n                {UserMusic:\n                    [\n                        {\n                            music_id: response,\n                            adder_id: this.myId,\n                            author: author,\n                            name: title\n                        },\n\n                        ...state.UserMusic\n                    ],\n                offset: state.offset + 1\n            }))\n        }else{\n            this.handleError(\"ошибка отправки данных на сервер\");\n        }\n    }\n\n    addToPlaylistHandler = async (music_id) => {\n       const [error] = await Fetcher(\n            HTTP + ADDR + \"/music/add_to_playlist\",\n            {musicId: music_id},\n            \"POST\",\n            \"text\"\n        )\n        if (error !== null){\n            this.handleError(\"ошибка при добавлении музыки в плейлист\");\n        }\n    }\n\n    deleteMusic = async(musicId) =>{\n        const [error] = await Fetcher(\n            HTTP + ADDR + \"/music/remove_music\",\n            {musicId},\n            \"GET\",\n            \"text\"\n        )\n        if (error === null){\n            this.setState(state => ({\n                offset: this.offset - 1,\n                UserMusic: state.UserMusic.filter((track)=>track.music_id !== musicId)}\n                ));\n        }else {\n            this.handleError(\"ошибка при удалении музыки\");\n        }\n    }\n\n    playUserMusicHandler = (offset) => {\n        this.props.updatePlayerStoreState({\n            playlist: this.state.UserMusic,\n            trackIndex: offset,\n            done: false,\n            playlistName: \"UserMusic\",\n            withValue: this.state.searchInputValue,\n            userId: this.pageId\n        })\n    }\n\n    playAllMusicHandler = (offset) => {\n        this.props.updatePlayerStoreState({\n            playlist: this.state.AllMusic,\n            trackIndex: offset,\n            done: false,\n            playlistName: \"AllMusic\",\n            withValue: this.state.searchInputValue,\n            userId: this.pageId\n        })\n    }\n\n    onInputChange = (event)=> {\n        this.setState({searchInputValue: event.target.value});\n        this.fetchInitialMusicDebounced()\n    }\n\n    render() {\n        return (\n            <div className={\"page__container\"}>\n                {this.state.error && <InfoPopup text = {this.state.error} handleClose = {this.handleClose}/>}\n                <div className={\"page__header background_pic__city background_pic__city_green\"}>\n                    <h1 style={{color: \"white\"}}>Музыка</h1>\n                    <p style={{color:  \"white\"}}>Здесь вы можете послушать музыку</p>\n                    <div className={\"audio_foreground_pic default_img\"}/>\n                </div>\n                <div className={\"VA_func_block\"}>\n                    <input className={\"default_search_input\"}\n                           placeholder={\"Поиск музыки\"}\n                           value={this.state.searchInputValue}\n                           onChange={this.onInputChange}/>\n                    <input\n                        type={\"file\"}\n                        className={\"hidden_input\"}\n                        id = {\"select_audio_file__input\"}\n                        accept={\"audio/*\"}\n                        ref = {this.addMusicRef}\n                        onChange={this.onFileDownloaded}\n                    />\n                    <label htmlFor=\"select_audio_file__input\">+</label>\n                </div>\n                {\n                    this.state.UserMusic.map( (track, offset) =>\n                        <UserTrack\n                            key = {track.music_id}\n                            offset = {offset}\n                            playMusicHandler = {this.playUserMusicHandler}\n                            deleteMusicHandler = {this.deleteMusic}\n                            name = {track.name}\n                            author = {track.author}\n                            music_id = {track.music_id}\n                            isPageMine = {this.isPageMine}\n                        />\n                    )\n                }\n                {this.state.AllMusic.length ? <div>Все аудиозаписи</div> : null}\n                {\n                    this.state.AllMusic.map((track,offset) =>\n                        <UserTrack\n                            key = {track.music_id}\n                            offset = {offset}\n                            name = {track.name}\n                            author = {track.author}\n                            music_id = {track.music_id}\n                            playMusicHandler = {this.playAllMusicHandler}\n                            addToPlaylistHandler = {this.addToPlaylistHandler}\n                        />\n                    )\n                }\n                {this.state.isFetching && <span>Загрузка...</span>}\n                {this.state.popupOpen && <AddAudioPopup onClose={this.onPopupClose} _onSend={this.postMusic}/>}\n            </div>\n\n        )\n    }\n}\n\nconst UserTrack = memo(({isPageMine, playMusicHandler, deleteMusicHandler, offset, name, author, music_id, addToPlaylistHandler})=>{\n    const [buttonActive, updateButtonActive] = useState(true);\n\n    const onPlay = () =>{\n        playMusicHandler(offset)\n    }\n\n    const onDelete = (e) =>{\n        e.stopPropagation();\n        deleteMusicHandler(music_id);\n    }\n\n    const onAdd = (e)=>{\n        e.stopPropagation();\n        addToPlaylistHandler(music_id);\n        updateButtonActive(false);\n    }\n\n\n    return (\n        <div className={\"audio_track\"} onClick={onPlay}>\n            <div className={\"audio_info\"}>\n                <img className={\"audio_cover\"} src={track_cover} alt = {\" \"}/>\n                <span className={\"audio_track__name\"}>{name}</span>\n                <span className={\"audio_track__author\"}>{author}</span>\n            </div>\n            {isPageMine ?\n                <div>\n                    <button className={\"audio__button audio__button-delete\"}\n                            onClick={onDelete}>❌</button>\n                </div>\n                :\n                <div>\n                    <button className={\"audio__button audio__button-add\"}\n                            onClick={onAdd}\n                            disabled={!buttonActive}\n                    >{buttonActive ? '+' : '✓'}</button>\n                </div>\n\n            }\n        </div>\n        )\n});\n\nfunction AddAudioPopup({onClose, _onSend}) {\n    const [author, _updateAuthor] = useState(\"\");\n    const [title, _updateTitle] = useState(\"\");\n\n    const onSend = () =>{\n        _onSend(author, title);\n    }\n    const updateAuthor = ({target})=>{\n        _updateAuthor(target.value);\n    }\n    const updateTitle = ({target})=>{\n        _updateTitle(target.value);\n    }\n    return (\n        <div className=\"b-popup\">\n            <div className=\"b-popup-content\">\n                <button className={\"popup_button__close\"} onClick={onClose}>×</button>\n                <input placeholder={\"Автор\"} value={author} onChange={updateAuthor}/>\n                <input placeholder={\"Название\"} value={title} onChange={updateTitle}/>\n                <button className={\"popup_button__action\"} onClick={onSend}>Загрузить</button>\n            </div>\n        </div>\n    )\n}\n\nexport default withRouter(AudioPage);","module.exports = __webpack_public_path__ + \"static/media/track_cover.384858af.ico\";"],"sourceRoot":""}