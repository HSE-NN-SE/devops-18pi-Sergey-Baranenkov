{"version":3,"sources":["components/audio/AudioPage.js","images/track_cover.ico"],"names":["AudioPage","state","UserMusic","AllMusic","offset","searchInputValue","isFetching","popupOpen","Done","error","pageId","props","match","params","id","myId","getCookie","isPageMine","fetchLimit","addMusicRef","createRef","handleError","bind","handleClose","fetchMusic","a","val","address","HTTP","ADDR","userId","withValue","limit","setState","Fetcher","response","fetchInitialMusic","handleScrollThrottled","Throttle","console","log","Math","abs","window","scrollY","innerHeight","document","documentElement","scrollHeight","fetchInitialMusicDebounced","Debounce","onPopupClose","onFileDownloaded","current","files","length","postMusic","author","title","data","FormData","append","music_id","adder_id","name","addToPlaylistHandler","musicId","deleteMusic","filter","track","playUserMusicHandler","updatePlayerStoreState","playlist","trackIndex","done","playlistName","playAllMusicHandler","onInputChange","event","target","value","this","addEventListener","removeEventListener","prevProps","prevState","snapshot","className","text","style","color","placeholder","onChange","htmlFor","type","accept","ref","map","UserTrack","key","playMusicHandler","deleteMusicHandler","AddAudioPopup","onClose","_onSend","React","Component","memo","useState","buttonActive","updateButtonActive","onClick","src","track_cover","alt","e","stopPropagation","disabled","_updateAuthor","_updateTitle","withRouter","module","exports"],"mappings":"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","file":"static/js/4.281b1a5c.chunk.js","sourcesContent":["import React, {createRef, useState, memo} from \"react\";\nimport \"./audio.scss\"\nimport \"../../scss/video_audio.scss\";\nimport \"../../scss/default_popup.scss\"\nimport Debounce from \"../../functools/Debounce\";\nimport Throttle from \"../../functools/Trottle\";\nimport Fetcher from \"../../functools/Fetcher\";\nimport \"../../scss/hidden_input.scss\"\nimport {withRouter} from \"react-router-dom\"\nimport track_cover from \"../../images/track_cover.ico\"\nimport {HTTP,  ADDR} from \"../../address\";\nimport InfoPopup, {handleError, handleClose} from \"../infoPopup/infoPopup\";\nimport getCookie from \"../../functools/getCookie\";\n\nclass AudioPage extends React.Component{\n    state = {\n        UserMusic: [],\n        AllMusic : [],\n        offset: 0,\n        searchInputValue: \"\",\n        isFetching: false,\n        popupOpen: false,\n        Done: false,\n        error: null\n    }\n    pageId = + this.props.match.params.id;\n    myId = + getCookie(\"userId\");\n    isPageMine = this.myId === this.pageId;\n\n    fetchLimit = 20;\n    addMusicRef = createRef();\n    handleError = handleError.bind(this);\n    handleClose = handleClose.bind(this);\n    fetchMusic = async () => {\n        const offset = this.state.offset;\n        const val = this.state.searchInputValue;\n        const address = HTTP + ADDR + `/music/${val === \"\"? \"get_user_music\" : \"get_combined_music\" }`;\n        const params = {userId: this.pageId, offset: offset, withValue: val, limit: this.fetchLimit}\n        this.setState({isFetching: true});\n        const [error, response] = await Fetcher(\n            address,\n            params\n        )\n        if (error === null){\n            this.setState(state => ({\n                offset: offset + this.fetchLimit,\n                UserMusic: [...state.UserMusic, ...response.UserMusic],\n                AllMusic: [...state.AllMusic, ...response.AllMusic],\n                Done: response.Done\n            }));\n        }else {\n            this.handleError(\"ошибка при получении данных с сервера\");\n        }\n        this.setState({isFetching: false});\n    }\n\n    fetchInitialMusic = ()=> {\n        this.setState(\n            {offset: 0, Done: false, UserMusic: [], AllMusic : []},\n            () => this.fetchMusic()\n        );\n    }\n\n    componentDidMount(){\n        this.fetchInitialMusic();\n        window.addEventListener('scroll', this.handleScrollThrottled, true);\n    }\n\n    componentWillUnmount() {\n        window.removeEventListener('scroll', this.handleScrollThrottled);\n    }\n\n    componentDidUpdate(prevProps, prevState, snapshot) {\n        if (prevProps.match.params.id !== this.props.match.params.id){\n            this.pageId = + this.props.match.params.id;\n            this.isPageMine = this.myId === this.pageId;\n            this.setState({UserMusic: [],\n                AllMusic : [],\n                offset: 0,\n                searchInputValue: \"\",\n                isFetching: false,\n                popupOpen: false,\n                Done: false,\n                error: null}, ()=> this.fetchInitialMusic());\n        }\n    }\n\n    handleScrollThrottled = Throttle(()=>{\n        console.log(this.state.Done, this.state.popupOpen, this.state.isFetching);\n        if ((Math.abs(window.scrollY + window.innerHeight - document.documentElement.scrollHeight) < 10)\n            &&\n            !this.state.Done\n            &&\n            !this.state.popupOpen\n            &&\n            !this.state.isFetching\n        ){\n            this.fetchMusic();\n        }\n    }, 1000 )\n\n\n    fetchInitialMusicDebounced = Debounce(()=>{\n        this.setState(\n            {UserMusic: [], AllMusic : [], offset: 0},\n            () =>this.fetchInitialMusic()\n        );\n    }, 500);\n\n\n    onPopupClose = ()=>{\n        this.setState({popupOpen: false});\n    }\n\n    onFileDownloaded = ()=>{\n        if (this.addMusicRef.current.files.length) {\n            this.setState({popupOpen: true});\n        }\n    }\n\n    postMusic = async (author, title)=>{\n        this.onPopupClose();\n        const data = new FormData();\n        data.append(\"audio\", this.addMusicRef.current.files[0])\n        const [error, response] = await Fetcher(\n            HTTP + ADDR + \"/music/post_music\",\n            {author, title},\n            'POST',\n            \"text\",\n            data);\n\n        if (error === null){\n            this.setState(state => (\n                {UserMusic:\n                    [\n                        {\n                            music_id: response,\n                            adder_id: this.myId,\n                            author: author,\n                            name: title\n                        },\n\n                        ...state.UserMusic\n                    ],\n                offset: state.offset + 1\n            }))\n        }else{\n            this.handleError(\"ошибка отправки данных на сервер\");\n        }\n    }\n\n    addToPlaylistHandler = async (music_id) => {\n       const [error] = await Fetcher(\n            HTTP + ADDR + \"/music/add_to_playlist\",\n            {musicId: music_id},\n            \"POST\",\n            \"text\"\n        )\n        if (error !== null){\n            this.handleError(\"ошибка при добавлении музыки в плейлист\");\n        }\n    }\n\n    deleteMusic = async(musicId) =>{\n        const [error] = await Fetcher(\n            HTTP + ADDR + \"/music/remove_music\",\n            {musicId},\n            \"GET\",\n            \"text\"\n        )\n        if (error === null){\n            this.setState(state => ({\n                offset: this.offset - 1,\n                UserMusic: state.UserMusic.filter((track)=>track.music_id !== musicId)}\n                ));\n        }else {\n            this.handleError(\"ошибка при удалении музыки\");\n        }\n    }\n\n    playUserMusicHandler = (offset) => {\n        this.props.updatePlayerStoreState({\n            playlist: this.state.UserMusic,\n            trackIndex: offset,\n            done: false,\n            playlistName: \"UserMusic\",\n            withValue: this.state.searchInputValue,\n            userId: this.pageId\n        })\n    }\n\n    playAllMusicHandler = (offset) => {\n        this.props.updatePlayerStoreState({\n            playlist: this.state.AllMusic,\n            trackIndex: offset,\n            done: false,\n            playlistName: \"AllMusic\",\n            withValue: this.state.searchInputValue,\n            userId: this.pageId\n        })\n    }\n\n    onInputChange = (event)=> {\n        this.setState({searchInputValue: event.target.value});\n        this.fetchInitialMusicDebounced()\n    }\n\n    render() {\n        return (\n            <div className={\"page__container\"}>\n                {this.state.error && <InfoPopup text = {this.state.error} handleClose = {this.handleClose}/>}\n                <div className={\"page__header background_pic__city background_pic__city_green\"}>\n                    <h1 style={{color: \"white\"}}>Музыка</h1>\n                    <p style={{color:  \"white\"}}>Здесь вы можете послушать музыку</p>\n                    <div className={\"audio_foreground_pic default_img\"}/>\n                </div>\n                <div className={\"VA_func_block\"}>\n                    <input className={\"default_search_input\"}\n                           placeholder={\"Поиск музыки\"}\n                           value={this.state.searchInputValue}\n                           onChange={this.onInputChange}/>\n                    {\n                        this.isPageMine &&\n                        <label htmlFor=\"select_audio_file__input\">+</label>\n                    }\n                    <input\n                        type={\"file\"}\n                        className={\"hidden_input\"}\n                        id = {\"select_audio_file__input\"}\n                        accept={\"audio/*\"}\n                        ref = {this.addMusicRef}\n                        onChange={this.onFileDownloaded}\n                    />\n\n                </div>\n                {\n                    this.state.UserMusic.map( (track, offset) =>\n                        <UserTrack\n                            key = {track.music_id}\n                            offset = {offset}\n                            playMusicHandler = {this.playUserMusicHandler}\n                            deleteMusicHandler = {this.deleteMusic}\n                            name = {track.name}\n                            author = {track.author}\n                            music_id = {track.music_id}\n                            isPageMine = {this.isPageMine}\n                        />\n                    )\n                }\n                {this.state.AllMusic.length ? <div>Все аудиозаписи</div> : null}\n                {\n                    this.state.AllMusic.map((track,offset) =>\n                        <UserTrack\n                            key = {track.music_id}\n                            offset = {offset}\n                            name = {track.name}\n                            author = {track.author}\n                            music_id = {track.music_id}\n                            playMusicHandler = {this.playAllMusicHandler}\n                            addToPlaylistHandler = {this.addToPlaylistHandler}\n                        />\n                    )\n                }\n                {this.state.isFetching && <span>Загрузка...</span>}\n                {this.state.popupOpen && <AddAudioPopup onClose={this.onPopupClose} _onSend={this.postMusic}/>}\n            </div>\n\n        )\n    }\n}\n\nconst UserTrack = memo(({isPageMine, playMusicHandler, deleteMusicHandler, offset, name, author, music_id, addToPlaylistHandler})=>{\n    const [buttonActive, updateButtonActive] = useState(true);\n\n    const onPlay = () =>{\n        playMusicHandler(offset)\n    }\n\n    const onDelete = (e) =>{\n        e.stopPropagation();\n        deleteMusicHandler(music_id);\n    }\n\n    const onAdd = (e)=>{\n        e.stopPropagation();\n        addToPlaylistHandler(music_id);\n        updateButtonActive(false);\n    }\n\n\n    return (\n        <div className={\"audio_track\"} onClick={onPlay}>\n            <div className={\"audio_info\"}>\n                <img className={\"audio_cover\"} src={track_cover} alt = {\" \"}/>\n                <span className={\"audio_track__name\"}>{name}</span>\n                <span className={\"audio_track__author\"}>{author}</span>\n            </div>\n            {isPageMine ?\n                <div>\n                    <button className={\"audio__button audio__button-delete\"}\n                            onClick={onDelete}>❌</button>\n                </div>\n                :\n                <div>\n                    <button className={\"audio__button audio__button-add\"}\n                            onClick={onAdd}\n                            disabled={!buttonActive}\n                    >{buttonActive ? '+' : '✓'}</button>\n                </div>\n\n            }\n        </div>\n        )\n});\n\nfunction AddAudioPopup({onClose, _onSend}) {\n    const [author, _updateAuthor] = useState(\"\");\n    const [title, _updateTitle] = useState(\"\");\n\n    const onSend = () =>{\n        _onSend(author, title);\n    }\n    const updateAuthor = ({target})=>{\n        _updateAuthor(target.value);\n    }\n    const updateTitle = ({target})=>{\n        _updateTitle(target.value);\n    }\n    return (\n        <div className=\"b-popup\">\n            <div className=\"b-popup-content\">\n                <button className={\"popup_button__close\"} onClick={onClose}>×</button>\n                <input placeholder={\"Автор\"} value={author} onChange={updateAuthor}/>\n                <input placeholder={\"Название\"} value={title} onChange={updateTitle}/>\n                <button className={\"popup_button__action\"} onClick={onSend}>Загрузить</button>\n            </div>\n        </div>\n    )\n}\n\nexport default withRouter(AudioPage);","module.exports = __webpack_public_path__ + \"static/media/track_cover.384858af.ico\";"],"sourceRoot":""}